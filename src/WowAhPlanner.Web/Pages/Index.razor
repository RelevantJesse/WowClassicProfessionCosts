@page "/"
@inject SelectionState Selection
@inject RealmCatalog RealmCatalog

<PageTitle>WoW AH Planner</PageTitle>

<h1>WoW Classic Auction House Profession Planner</h1>

<div class="card">
    <h3>Realm</h3>
    <div class="grid">
        <label>
            Game version
            <select @bind="Selection.GameVersion" @bind:after="OnVersionOrRegionChanged">
                @foreach (var version in Enum.GetValues<GameVersion>())
                {
                    <option value="@version">@version</option>
                }
            </select>
        </label>

        <label>
            Region
            <select @bind="Selection.Region" @bind:after="OnVersionOrRegionChanged">
                @foreach (var region in Enum.GetValues<Region>())
                {
                    <option value="@region">@region</option>
                }
            </select>
        </label>

        <label>
            Realm
            <select @bind="Selection.RealmSlug" @bind:after="OnRealmChanged">
                @foreach (var realm in _realms)
                {
                    <option value="@realm.Slug">@realm.Name</option>
                }
            </select>
        </label>
    </div>

    <p>
        Current realm key: <code>@Selection.ToRealmKey()</code>
    </p>
</div>

<div class="card">
    <h3>Next</h3>
    <p>
        Use <a href="/recipes">Recipes</a> to browse the profession pack, then <a href="/plan">Plan</a> to generate a leveling plan.
    </p>
</div>

@code {
    private IReadOnlyList<Realm> _realms = [];

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;

        await Selection.EnsureLoadedAsync();
        RefreshRealms();
        await Selection.PersistAsync();

        StateHasChanged();
    }

    private async Task OnVersionOrRegionChanged()
    {
        RefreshRealms();
        await Selection.PersistAsync();
    }

    private async Task OnRealmChanged()
    {
        await Selection.PersistAsync();
    }

    private void RefreshRealms()
    {
        _realms = RealmCatalog.GetRealms(Selection.Region, Selection.GameVersion);
        if (_realms.Count > 0 && !_realms.Any(r => r.Slug == Selection.RealmSlug))
        {
            Selection.RealmSlug = _realms[0].Slug;
        }
    }
}

