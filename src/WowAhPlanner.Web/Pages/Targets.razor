@page "/targets"
@inject SelectionState Selection
@inject WowAhPlanner.Core.Ports.IRecipeRepository RecipeRepository
@inject NavigationManager Nav
@inject HttpClient Http

<PageTitle>Scan targets</PageTitle>

<h1>Scan Targets</h1>

<div class="card">
    <h3>Profession</h3>
    <div class="grid">
        <label>
            Profession
            <select @bind="_professionId" @bind:after="OnProfessionChanged">
                @foreach (var p in _professions)
                {
                    <option value="@p.ProfessionId">@p.Name (@p.ProfessionId)</option>
                }
            </select>
        </label>

        <label>
            <input type="checkbox" @bind="_useCraftIntermediates" @bind:after="OnOptionsChanged" />
            Craft other-profession intermediates (optional)
        </label>

        <label>
            <input type="checkbox" @bind="_useSmeltIntermediates" @bind:after="OnOptionsChanged" />
            Smelt intermediates (bars from ore)
        </label>
    </div>

    <p>
        This generates a Lua file containing all recipes for the selected profession.
        The addon will automatically scan items for recipes from your current skill up to
        <span class="badge">@_maxSkillDelta</span> skill points higher (default 100), clamped to an expansion cap (configured in the addon; default 350).
    </p>
</div>

<div class="card">
    <h3>Download</h3>
    <p>
        <a href="@_recipeTargetsUrl" target="_blank">Download recipe targets (.lua)</a>
    </p>
    <p><code>@_recipeTargetsUrl</code></p>
    <p>
        Troubleshooting: <a href="@_itemTargetsUrl" target="_blank">Download raw item targets (.lua)</a> (no skill filtering; scans every reagent in the pack).
    </p>
    <p><code>@_itemTargetsUrl</code></p>
</div>

<div class="card">
    <h3>Install to WoW</h3>
    <p>
        Updates <code>WowAhPlannerScan_Targets.lua</code> inside your local WoW AddOns folder (Anniversary expects <code>_anniversary_</code>).
        If auto-detection fails, set <code>WowAddon:InstallPaths:Anniversary</code> in <code>src/WowAhPlanner.Web/appsettings.json</code>.
    </p>
    <button @onclick="InstallAsync" disabled="@(_installBusy)">Install targets</button>
    @if (!string.IsNullOrWhiteSpace(_installMessage))
    {
        <p>@_installMessage</p>
    }
</div>

@code {
    private IReadOnlyList<Profession> _professions = [];
    private int _professionId;
    private int _maxSkillDelta = 100;
    private bool _useCraftIntermediates = false;
    private bool _useSmeltIntermediates = true;

    private string _recipeTargetsUrl = "";
    private string _itemTargetsUrl = "";
    private bool _installBusy;
    private string? _installMessage;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;

        await Selection.EnsureLoadedAsync();
        _professions = await RecipeRepository.GetProfessionsAsync(Selection.GameVersion, CancellationToken.None);
        _professionId = _professions.Any(p => p.ProfessionId == Selection.ProfessionId)
            ? Selection.ProfessionId
            : _professions.FirstOrDefault()?.ProfessionId ?? 0;

        RebuildUrls();
        StateHasChanged();
    }

    private async Task OnProfessionChanged()
    {
        Selection.ProfessionId = _professionId;
        await Selection.PersistAsync();
        RebuildUrls();
    }

    private void OnOptionsChanged()
    {
        RebuildUrls();
    }

    private void RebuildUrls()
    {
        var version = Selection.GameVersion.ToString();
        var region = Selection.Region.ToString();
        var realmSlug = Selection.RealmSlug;
        var craft = _useCraftIntermediates ? "true" : "false";
        var smelt = _useSmeltIntermediates ? "true" : "false";

        _recipeTargetsUrl = Nav.ToAbsoluteUri(
            $"/api/scans/recipeTargets.lua?version={Uri.EscapeDataString(version)}&professionId={_professionId}&useCraftIntermediates={craft}&useSmeltIntermediates={smelt}&region={Uri.EscapeDataString(region)}&realmSlug={Uri.EscapeDataString(realmSlug)}").ToString();
        _itemTargetsUrl = Nav.ToAbsoluteUri(
            $"/api/scans/targets.lua?version={Uri.EscapeDataString(version)}&professionId={_professionId}&useCraftIntermediates={craft}&useSmeltIntermediates={smelt}").ToString();
    }

    private async Task InstallAsync()
    {
        _installBusy = true;
        _installMessage = null;

        try
        {
            var uri = Nav.ToAbsoluteUri("/api/scans/installTargets");
            var resp = await Http.PostAsJsonAsync(uri, new
            {
                gameVersion = Selection.GameVersion,
                professionId = _professionId,
                useCraftIntermediates = _useCraftIntermediates,
                useSmeltIntermediates = _useSmeltIntermediates,
                region = Selection.Region,
                realmSlug = Selection.RealmSlug,
            });
            var body = await resp.Content.ReadAsStringAsync();
            _installMessage = resp.IsSuccessStatusCode ? body : $"Error: {body}";
        }
        catch (Exception ex)
        {
            _installMessage = ex.Message;
        }
        finally
        {
            _installBusy = false;
        }
    }
}
