@page "/recipes"
@inject SelectionState Selection
@inject WowAhPlanner.Core.Ports.IRecipeRepository RecipeRepository

<PageTitle>Recipes</PageTitle>

<h1>Recipes</h1>

<div class="card">
    <div class="grid">
        <label>
            Profession
            <select @bind="_professionId" @bind:after="OnProfessionChanged">
                @foreach (var p in _professions)
                {
                    <option value="@p.ProfessionId">@p.Name (@p.ProfessionId)</option>
                }
            </select>
        </label>
    </div>
</div>

<div class="card">
    <h3>Pack: @Selection.GameVersion</h3>

    @if (_recipes.Count == 0)
    {
        <p>No recipes loaded.</p>
    }
    else
    {
        <table>
            <thead>
            <tr>
                <th>Recipe</th>
                <th>Min</th>
                <th>Orange</th>
                <th>Yellow</th>
                <th>Green</th>
                <th>Gray</th>
                <th>Reagents</th>
            </tr>
            </thead>
            <tbody>
            @foreach (var r in _recipes)
            {
                <tr>
                    <td>@r.Name <span class="badge">@r.RecipeId</span></td>
                    <td>@r.MinSkill</td>
                    <td>@r.OrangeUntil</td>
                    <td>@r.YellowUntil</td>
                    <td>@r.GreenUntil</td>
                    <td>@r.GrayAt</td>
                    <td>
                        @foreach (var reagent in r.Reagents)
                        {
                            <div>@reagent.Quantity x <code>@reagent.ItemId</code></div>
                        }
                    </td>
                </tr>
            }
            </tbody>
        </table>
    }
</div>

@code {
    private IReadOnlyList<Profession> _professions = [];
    private int _professionId;
    private IReadOnlyList<Recipe> _recipes = [];

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;

        await Selection.EnsureLoadedAsync();
        await LoadProfessionsAndRecipes();
        StateHasChanged();
    }

    private async Task OnProfessionChanged()
    {
        Selection.ProfessionId = _professionId;
        await Selection.PersistAsync();
        await LoadRecipes();
    }

    private async Task LoadProfessionsAndRecipes()
    {
        _professions = await RecipeRepository.GetProfessionsAsync(Selection.GameVersion, CancellationToken.None);

        var preferred = Selection.ProfessionId;
        _professionId = _professions.Any(p => p.ProfessionId == preferred)
            ? preferred
            : _professions.FirstOrDefault()?.ProfessionId ?? 0;

        await LoadRecipes();
    }

    private async Task LoadRecipes()
    {
        _recipes = _professionId == 0
            ? []
            : await RecipeRepository.GetRecipesAsync(Selection.GameVersion, _professionId, CancellationToken.None);
    }
}

