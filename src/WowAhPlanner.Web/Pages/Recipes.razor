@page "/recipes"
@inject SelectionState Selection
@inject WowAhPlanner.Core.Ports.IRecipeRepository RecipeRepository
@inject PlannerPreferences PlannerPreferences

<PageTitle>Recipes</PageTitle>

<h1>Recipes</h1>

<div class="card">
    <div class="grid">
        <label>
            Profession
            <select @bind="_professionId" @bind:after="OnProfessionChanged">
                @foreach (var p in _professions)
                {
                    <option value="@p.ProfessionId">@p.Name (@p.ProfessionId)</option>
                }
            </select>
        </label>
    </div>
</div>

<div class="card">
    <h3>Pack: @Selection.GameVersion</h3>

    @if (_recipes.Count == 0)
    {
        <p>No recipes loaded.</p>
    }
    else
    {
        <table>
            <thead>
            <tr>
                <th>Recipe</th>
                <th>Exclude</th>
                <th>Min</th>
                <th>Orange</th>
                <th>Yellow</th>
                <th>Green</th>
                <th>Gray</th>
                <th>Reagents</th>
            </tr>
            </thead>
            <tbody>
            @foreach (var r in _recipes)
            {
                <tr>
                    <td>@r.Name <span class="badge">@r.RecipeId</span></td>
                    <td>
                        <input type="checkbox"
                               checked="@_excludedRecipeIds.Contains(r.RecipeId)"
                               @onchange="e => SetExcludedAsync(r.RecipeId, e)" />
                    </td>
                    <td>@r.MinSkill</td>
                    <td>@r.OrangeUntil</td>
                    <td>@r.YellowUntil</td>
                    <td>@r.GreenUntil</td>
                    <td>@r.GrayAt</td>
                    <td>
                        @foreach (var reagent in r.Reagents)
                        {
                            <div>@reagent.Quantity x <code>@reagent.ItemId</code></div>
                        }
                    </td>
                </tr>
            }
            </tbody>
        </table>
    }
</div>

@code {
    private IReadOnlyList<Profession> _professions = [];
    private int _professionId;
    private IReadOnlyList<Recipe> _recipes = [];
    private HashSet<string> _excludedRecipeIds = new(StringComparer.OrdinalIgnoreCase);

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;

        await Selection.EnsureLoadedAsync();
        await PlannerPreferences.EnsureLoadedAsync();
        await LoadProfessionsAndRecipes();
        StateHasChanged();
    }

    private async Task OnProfessionChanged()
    {
        Selection.ProfessionId = _professionId;
        await Selection.PersistAsync();
        await LoadRecipes();
    }

    private async Task LoadProfessionsAndRecipes()
    {
        _professions = await RecipeRepository.GetProfessionsAsync(Selection.GameVersion, CancellationToken.None);

        var preferred = Selection.ProfessionId;
        _professionId = _professions.Any(p => p.ProfessionId == preferred)
            ? preferred
            : _professions.FirstOrDefault()?.ProfessionId ?? 0;

        await LoadRecipes();
    }

    private async Task LoadRecipes()
    {
        _excludedRecipeIds = new HashSet<string>(
            PlannerPreferences.GetExcludedRecipeIds(Selection.GameVersion, _professionId),
            StringComparer.OrdinalIgnoreCase);

        _recipes = _professionId == 0
            ? []
            : await RecipeRepository.GetRecipesAsync(Selection.GameVersion, _professionId, CancellationToken.None);
    }

    private async Task SetExcludedAsync(string recipeId, ChangeEventArgs e)
    {
        var excluded =
            e.Value is bool b ? b :
            e.Value is string s && bool.TryParse(s, out var parsed) && parsed;

        await PlannerPreferences.SetRecipeExcludedAsync(Selection.GameVersion, _professionId, recipeId, excluded);

        if (excluded)
        {
            _excludedRecipeIds.Add(recipeId);
        }
        else
        {
            _excludedRecipeIds.Remove(recipeId);
        }
    }
}
