@page "/upload"
@inject SelectionState Selection
@inject WowAhPlanner.Infrastructure.Pricing.UploadedSnapshotIngestService SnapshotIngest

<PageTitle>Upload snapshot</PageTitle>

<h1>Upload AH Snapshot</h1>

<div class="card">
    <h3>Realm</h3>
    <p>Upload will be stored for: <code>@Selection.ToRealmKey()</code></p>
    <p>Provider name used: <span class="badge">UploadedSnapshot</span></p>
    <p>Tip: set <code>Pricing:PrimaryProviderName</code> to <code>UploadedSnapshot</code> in <code>src/WowAhPlanner.Web/appsettings.json</code>.</p>
    <p>Uploads are aggregated across the last few uploads to reduce bad/outlier data.</p>
</div>

<div class="card">
    <h3>Import from SavedVariables (no copy/paste)</h3>
    <p>
        Point this at your <code>WTF\Account\...\SavedVariables\ProfessionLevelerScan.lua</code> file.
        Note: WoW writes SavedVariables on <code>/reload</code>, logout, or exit.
    </p>
    <input type="text" @bind="_savedVariablesPath" style="width:100%" placeholder="C:\Program Files (x86)\World of Warcraft\_anniversary_\WTF\Account\...\SavedVariables\ProfessionLevelerScan.lua" />
    <div style="margin-top:0.75rem">
        <button @onclick="LoadFromSavedVariablesAsync" disabled="@_busy">Load into textarea</button>
        <button @onclick="LoadAndUploadFromSavedVariablesAsync" disabled="@_busy">Load + Upload</button>
    </div>
</div>

<div class="card">
    <h3>Paste JSON</h3>
    <p>Expected schema: <span class="badge">wowahplanner-scan-v1</span></p>
    <label style="display:block;margin-bottom:0.5rem">
        <input type="checkbox" @bind="_allowSnapshotMismatch" />
        Allow uploading snapshots whose (region/version/realmSlug) do not match current selection
    </label>
    <textarea @bind="_json" style="width:100%;min-height:220px"></textarea>
    <div style="margin-top:0.75rem">
        <button @onclick="UploadAsync" disabled="@_busy">Upload</button>
    </div>
    @if (!string.IsNullOrWhiteSpace(_message))
    {
        <p>@_message</p>
    }
</div>

@code {
    private string _json = "";
    private string _savedVariablesPath = "";
    private bool _allowSnapshotMismatch;
    private string? _message;
    private bool _busy;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;
        await Selection.EnsureLoadedAsync();
        StateHasChanged();
    }

    private async Task UploadAsync()
    {
        _busy = true;
        _message = null;

        try
        {
            await UploadJsonAsync(_json);
        }
        finally
        {
            _busy = false;
        }
    }

    private async Task LoadFromSavedVariablesAsync()
    {
        _busy = true;
        _message = null;

        try
        {
            var json = await ReadLastSnapshotJsonFromSavedVariablesAsync(_savedVariablesPath);
            _json = json;
            _message = "Loaded snapshot JSON from SavedVariables. Click Upload to store it.";
        }
        catch (Exception ex)
        {
            _message = ex.Message;
        }
        finally
        {
            _busy = false;
        }
    }

    private async Task LoadAndUploadFromSavedVariablesAsync()
    {
        _busy = true;
        _message = null;

        try
        {
            var json = await ReadLastSnapshotJsonFromSavedVariablesAsync(_savedVariablesPath);
            _json = json;
            await UploadJsonAsync(json);
        }
        catch (Exception ex)
        {
            _message = ex.Message;
        }
        finally
        {
            _busy = false;
        }
    }

    private async Task UploadJsonAsync(string json)
    {
        try
        {
            var dto = System.Text.Json.JsonSerializer.Deserialize<UploadSnapshotDto>(
                json,
                new System.Text.Json.JsonSerializerOptions(System.Text.Json.JsonSerializerDefaults.Web));

            if (dto is null)
            {
                _message = "Invalid JSON (null).";
                return;
            }

            if (!string.Equals(dto.Schema, "wowahplanner-scan-v1", StringComparison.OrdinalIgnoreCase))
            {
                _message = $"Unsupported schema '{dto.Schema}'.";
                return;
            }

            if (dto.Prices is null || dto.Prices.Count == 0)
            {
                _message = "No prices[] found.";
                return;
            }

            var snapshotTs = dto.SnapshotTimestampUtc ?? DateTime.UtcNow;
            var selectionKey = Selection.ToRealmKey();
            var region = selectionKey.Region;
            var version = selectionKey.GameVersion;
            var realmSlug = selectionKey.RealmSlug;
            var hasAnyMeta =
                !string.IsNullOrWhiteSpace(dto.Region) ||
                !string.IsNullOrWhiteSpace(dto.GameVersion) ||
                !string.IsNullOrWhiteSpace(dto.RealmSlug);

            if (!string.IsNullOrWhiteSpace(dto.Region) &&
                !Enum.TryParse<WowAhPlanner.Core.Domain.Region>(dto.Region, true, out region))
            {
                _message = $"Invalid snapshot region '{dto.Region}'.";
                return;
            }

            if (!string.IsNullOrWhiteSpace(dto.GameVersion) &&
                !Enum.TryParse<WowAhPlanner.Core.Domain.GameVersion>(dto.GameVersion, true, out version))
            {
                _message = $"Invalid snapshot gameVersion '{dto.GameVersion}'.";
                return;
            }

            if (!string.IsNullOrWhiteSpace(dto.RealmSlug))
            {
                realmSlug = dto.RealmSlug.Trim();
            }

            var targetKey = new WowAhPlanner.Core.Domain.RealmKey(region, version, realmSlug);
            if (hasAnyMeta && targetKey != selectionKey && !_allowSnapshotMismatch)
            {
                _message =
                    $"Snapshot is for '{targetKey}', but current selection is '{selectionKey}'. " +
                    "Switch your selection to match, or check the box to allow mismatch.";
                return;
            }

            var realmKey = targetKey.ToString();
            var uploaderUserId = "local";

            var result = await SnapshotIngest.IngestAsync(
                realmKey: realmKey,
                snapshotTimestampUtc: snapshotTs,
                uploaderUserId: uploaderUserId,
                prices: dto.Prices.Select(p => new WowAhPlanner.Infrastructure.Pricing.UploadedSnapshotIngestService.UploadPriceRow(
                    p.ItemId,
                    p.MinUnitBuyoutCopper,
                    p.TotalQuantity)).ToArray());

            _message = result.UploadId is null
                ? "No prices were stored."
                : $"Stored upload {result.UploadId} with {result.StoredItemCount} prices (aggregated {result.AggregatedItemCount}).";
        }
        catch (Exception ex)
        {
            _message = ex.Message;
        }
    }

    private static async Task<string> ReadLastSnapshotJsonFromSavedVariablesAsync(string path)
    {
        if (string.IsNullOrWhiteSpace(path))
        {
            throw new InvalidOperationException("SavedVariables path is required.");
        }

        if (!File.Exists(path))
        {
            throw new FileNotFoundException("SavedVariables file not found.", path);
        }

        var content = await File.ReadAllTextAsync(path);
        var match = System.Text.RegularExpressions.Regex.Match(
            content,
            "(?:\\[\\s*\\\"lastSnapshotJson\\\"\\s*\\]|lastSnapshotJson)\\s*=\\s*\\\"(?<val>(?:\\\\.|[^\\\\\\\"])*?)\\\"",
            System.Text.RegularExpressions.RegexOptions.Singleline);

        if (!match.Success)
        {
            throw new InvalidOperationException("Could not find lastSnapshotJson in SavedVariables. Run a scan and then /reload (or logout/exit) so WoW writes SavedVariables.");
        }

        var escaped = match.Groups["val"].Value;
        return UnescapeLuaString(escaped);
    }

    private static string UnescapeLuaString(string value)
    {
        var sb = new System.Text.StringBuilder(value.Length);

        for (var i = 0; i < value.Length; i++)
        {
            var c = value[i];
            if (c != '\\')
            {
                sb.Append(c);
                continue;
            }

            if (i == value.Length - 1)
            {
                sb.Append('\\');
                break;
            }

            var n = value[++i];
            switch (n)
            {
                case '\\':
                    sb.Append('\\');
                    break;
                case '\"':
                    sb.Append('\"');
                    break;
                case 'n':
                    sb.Append('\n');
                    break;
                case 'r':
                    sb.Append('\r');
                    break;
                case 't':
                    sb.Append('\t');
                    break;
                default:
                    if (n >= '0' && n <= '9')
                    {
                        var num = n - '0';
                        var digits = 1;
                        while (digits < 3 && i + 1 < value.Length)
                        {
                            var d = value[i + 1];
                            if (d < '0' || d > '9') break;
                            num = (num * 10) + (d - '0');
                            i++;
                            digits++;
                        }

                        sb.Append((char)num);
                    }
                    else
                    {
                        sb.Append(n);
                    }
                    break;
            }
        }

        return sb.ToString();
    }

    private sealed class UploadSnapshotDto
    {
        public string? Schema { get; set; }
        public DateTime? SnapshotTimestampUtc { get; set; }
        public string? Region { get; set; }
        public string? GameVersion { get; set; }
        public string? RealmSlug { get; set; }
        public List<PriceDto>? Prices { get; set; }
    }

    private sealed class PriceDto
    {
        public int ItemId { get; set; }
        public long? MinUnitBuyoutCopper { get; set; }
        public long? TotalQuantity { get; set; }
    }
}
