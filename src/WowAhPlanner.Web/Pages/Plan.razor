@page "/plan"
@inject SelectionState Selection
@inject WowAhPlanner.Core.Ports.IRecipeRepository RecipeRepository
@inject WowAhPlanner.Core.Ports.IItemRepository ItemRepository
@inject WowAhPlanner.Core.Ports.IVendorPriceRepository VendorPriceRepository
@inject WowAhPlanner.Core.Services.PlannerService Planner
@inject WowAhPlanner.Infrastructure.Owned.OwnedMaterialsService Owned
@inject Microsoft.AspNetCore.Components.Authorization.AuthenticationStateProvider AuthStateProvider

<PageTitle>Plan</PageTitle>

<h1>Plan</h1>

<div class="card">
    <h3>Inputs</h3>
    <div class="grid">
        <label>
            Profession
            <select @bind="_professionId" @bind:after="OnProfessionChanged">
                @foreach (var p in _professions)
                {
                    <option value="@p.ProfessionId">@p.Name (@p.ProfessionId)</option>
                }
            </select>
        </label>

        <label>
            Current skill
            <input type="number" @bind="_currentSkill" min="0" max="450" />
        </label>

        <label>
            Target skill
            <input type="number" @bind="_targetSkill" min="0" max="450" />
        </label>

        <label>
            <input type="checkbox" @bind="_useCraftIntermediates" />
            Craft other-profession intermediates (optional)
        </label>

        <label>
            <input type="checkbox" @bind="_useSmeltIntermediates" />
            Smelt intermediates (bars from ore)
        </label>

        <label>
            <input type="checkbox" @bind="_useOwnedMaterials" />
            Subtract owned materials (requires login)
        </label>
    </div>

    <div style="margin-top:0.75rem">
        <button @onclick="GenerateAsync" disabled="@(!_ready)">Generate plan</button>
    </div>
</div>

@if (_result is not null)
{
    <div class="card">
        <h3>Pricing</h3>
        <p>
            Provider: <span class="badge">@_result.PriceSnapshot.ProviderName</span>
            Snapshot: <span class="badge">@_result.PriceSnapshot.SnapshotTimestampUtc.ToString("u")</span>
            @if (_result.PriceSnapshot.IsStale)
            {
                <span class="badge badge-stale">stale</span>
            }
            @if (!string.IsNullOrWhiteSpace(_result.PriceSnapshot.ErrorMessage))
            {
                <div class="badge badge-unavailable">@_result.PriceSnapshot.ErrorMessage</div>
            }
        </p>
    </div>

    @if (_result.Plan is null)
    {
        <div class="card">
            <h3>Unable to plan</h3>
            <p>@_result.ErrorMessage</p>

            @if (_result.MissingItemIds.Count > 0)
            {
                <p>Missing prices for:</p>
                <ul>
                    @foreach (var itemId in _result.MissingItemIds)
                    {
                        <li>
                            @(_itemNames.GetValueOrDefault(itemId) ?? $"Item {itemId}")
                            <span class="badge">@itemId</span>
                        </li>
                    }
                </ul>
            }
        </div>
    }
    else
    {
        <div class="card">
            <h3>Steps</h3>
            @if (_result.Plan.SkillCreditApplied > 0)
            {
                <p>
                    Intermediate skill-ups applied: <span class="badge">@_result.Plan.SkillCreditApplied</span>
                    (expected: @_result.Plan.ExpectedSkillUpsFromIntermediates.ToString("0.##")).
                    These appear in the steps list as recipes marked <span class="badge">Intermediate</span>.
                </p>
            }
            <table>
                <thead>
                <tr>
                    <th>Skill</th>
                    <th>Recipe</th>
                    <th>Chance</th>
                    <th>Expected crafts</th>
                    <th>Expected cost</th>
                </tr>
                </thead>
                <tbody>
                @foreach (var step in _result.Plan.Steps)
                {
                    <tr>
                        <td>@step.SkillFrom - @step.SkillTo</td>
                        <td>
                            @step.RecipeName <span class="badge">@step.RecipeId</span>
                            @if (step.RecipeName.Contains("(Intermediate)", StringComparison.OrdinalIgnoreCase))
                            {
                                <span class="badge">Intermediate</span>
                            }
                            @if (step.LearnedByTrainer == false)
                            {
                                <span class="badge badge-stale">recipe not from trainer</span>
                            }
                        </td>
                        <td>@step.SkillUpChance</td>
                        <td>@step.ExpectedCrafts.ToString("0.##")</td>
                        <td>@step.ExpectedCost.ToGscString()</td>
                    </tr>
                }
                </tbody>
            </table>
        </div>

        @if (_result.Plan.Intermediates.Count > 0)
        {
            <div class="card">
                <h3>Intermediates</h3>
                <table>
                    <thead>
                    <tr>
                        <th>Item</th>
                        <th>Quantity (expected)</th>
                        <th>Method</th>
                        <th>How</th>
                    </tr>
                    </thead>
                    <tbody>
                    @foreach (var line in _result.Plan.Intermediates)
                    {
                        <tr>
                            <td>
                                @(_itemNames.GetValueOrDefault(line.ItemId) ?? $"Item {line.ItemId}")
                                <span class="badge">@line.ItemId</span>
                            </td>
                            <td>@line.Quantity.ToString("0.##")</td>
                            <td>@line.Kind</td>
                            <td>@line.ProducerName</td>
                        </tr>
                    }
                    </tbody>
                </table>
            </div>
        }

        @if (_result.Plan.OwnedMaterialsUsed.Count > 0)
        {
            <div class="card">
                <h3>Already owned</h3>
                <table>
                    <thead>
                    <tr>
                        <th>Item</th>
                        <th>Quantity used</th>
                    </tr>
                    </thead>
                    <tbody>
                    @foreach (var line in _result.Plan.OwnedMaterialsUsed)
                    {
                        <tr>
                            <td>
                                @(_itemNames.GetValueOrDefault(line.ItemId) ?? $"Item {line.ItemId}")
                                <span class="badge">@line.ItemId</span>
                            </td>
                            <td>@line.QuantityUsed.ToString("0.##")</td>
                        </tr>
                    }
                    </tbody>
                </table>
            </div>
        }

        <div class="card">
            <h3>Shopping list</h3>
            <table>
                <thead>
                <tr>
                    <th>Item</th>
                    <th>Quantity (expected)</th>
                    <th>Unit price</th>
                    <th>Line cost</th>
                </tr>
                </thead>
                <tbody>
                @foreach (var line in _result.Plan.ShoppingList)
                {
                    <tr>
                        <td>
                            @(_itemNames.GetValueOrDefault(line.ItemId) ?? $"Item {line.ItemId}")
                            <span class="badge">@line.ItemId</span>
                            @if (_vendorItemIds.Contains(line.ItemId))
                            {
                                <span class="badge">vendor</span>
                            }
                        </td>
                        <td>@line.Quantity.ToString("0.##")</td>
                        <td>@line.UnitPrice.ToGscString()</td>
                        <td>@line.LineCost.ToGscString()</td>
                    </tr>
                }
                </tbody>
            </table>

            <p>
                Total: <span class="badge">@_result.Plan.TotalCost.ToGscString()</span>
            </p>
        </div>
    }
}

@code {
    private IReadOnlyList<Profession> _professions = [];
    private int _professionId;
    private int _currentSkill = 1;
    private int _targetSkill = 75;
    private bool _useCraftIntermediates = false;
    private bool _useSmeltIntermediates = true;
    private bool _useOwnedMaterials = true;
    private bool _ready;
    private Dictionary<int, string> _itemNames = new();
    private HashSet<int> _vendorItemIds = new();

    private PlanComputationResult? _result;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;

        await Selection.EnsureLoadedAsync();
        _professions = await RecipeRepository.GetProfessionsAsync(Selection.GameVersion, CancellationToken.None);

        var preferred = Selection.ProfessionId;
        _professionId = _professions.Any(p => p.ProfessionId == preferred)
            ? preferred
            : _professions.FirstOrDefault()?.ProfessionId ?? 0;

        _ready = _professionId != 0;
        StateHasChanged();
    }

    private async Task OnProfessionChanged()
    {
        Selection.ProfessionId = _professionId;
        await Selection.PersistAsync();
    }

    private async Task GenerateAsync()
    {
        _result = null;
        _itemNames = new Dictionary<int, string>();
        _vendorItemIds = new HashSet<int>();

        IReadOnlyDictionary<int, long>? owned = null;
        if (_useOwnedMaterials)
        {
            var auth = await AuthStateProvider.GetAuthenticationStateAsync();
            var userId = auth.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
            if (!string.IsNullOrWhiteSpace(userId))
            {
                owned = await Owned.GetOwnedAsync(Selection.ToRealmKey().ToString(), userId);
            }
        }

        var request = new PlanRequest(
            RealmKey: Selection.ToRealmKey(),
            ProfessionId: _professionId,
            CurrentSkill: _currentSkill,
            TargetSkill: _targetSkill,
            PriceMode: PriceMode.Min,
            UseCraftIntermediates: _useCraftIntermediates,
            UseSmeltIntermediates: _useSmeltIntermediates,
            OwnedMaterials: owned);

        _result = await Planner.BuildPlanAsync(request, CancellationToken.None);

        if (_result is null) return;

        var items = await ItemRepository.GetItemsAsync(Selection.GameVersion, CancellationToken.None);
        var vendor = await VendorPriceRepository.GetVendorPricesAsync(Selection.GameVersion, CancellationToken.None);

        var idsToName = new HashSet<int>(_result.MissingItemIds);
        if (_result.Plan is not null)
        {
            foreach (var id in _result.Plan.ShoppingList.Select(s => s.ItemId))
            {
                idsToName.Add(id);
            }

            foreach (var id in _result.Plan.Intermediates.Select(s => s.ItemId))
            {
                idsToName.Add(id);
            }

            foreach (var id in _result.Plan.OwnedMaterialsUsed.Select(s => s.ItemId))
            {
                idsToName.Add(id);
            }
        }

        foreach (var itemId in idsToName)
        {
            if (items.TryGetValue(itemId, out var name))
            {
                _itemNames[itemId] = name;
            }
            if (vendor.ContainsKey(itemId))
            {
                _vendorItemIds.Add(itemId);
            }
        }
    }
}
