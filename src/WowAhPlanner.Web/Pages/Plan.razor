@page "/plan"
@inject SelectionState Selection
@inject WowAhPlanner.Core.Ports.IRecipeRepository RecipeRepository
@inject WowAhPlanner.Core.Ports.IItemRepository ItemRepository
@inject WowAhPlanner.Core.Ports.IVendorPriceRepository VendorPriceRepository
@inject WowAhPlanner.Core.Services.PlannerService Planner
@inject WowAhPlanner.Infrastructure.Owned.OwnedMaterialsService Owned
@inject PlannerPreferences PlannerPreferences

<PageTitle>Plan</PageTitle>

<h1>Plan</h1>

<div class="card">
    <h3>Inputs</h3>
    <div class="grid">
        <label>
            Profession
            <select @bind="_professionId" @bind:after="OnProfessionChanged">
                @foreach (var p in _professions)
                {
                    <option value="@p.ProfessionId">@p.Name (@p.ProfessionId)</option>
                }
            </select>
        </label>

        <label>
            Current skill
            <input type="number" @bind="_currentSkill" min="0" max="450" />
        </label>

        <label>
            Target skill
            <input type="number" @bind="_targetSkill" min="0" max="450" />
        </label>

        <label>
            <input type="checkbox" @bind="_useCraftIntermediates" />
            Craft other-profession intermediates (optional)
        </label>

        <label>
            <input type="checkbox" @bind="_useSmeltIntermediates" />
            Smelt intermediates (bars from ore)
        </label>

        <label>
            <input type="checkbox" @bind="_useOwnedMaterials" />
            Subtract owned materials
        </label>
    </div>

    <div style="margin-top:0.75rem">
        <button @onclick="GenerateAsync" disabled="@(!_ready)">Generate plan</button>
    </div>
</div>

@if (_result is not null)
{
    <div class="card">
        <h3>Pricing</h3>
        <p>
            Provider: <span class="badge">@_result.PriceSnapshot.ProviderName</span>
            Snapshot: <span class="badge">@_result.PriceSnapshot.SnapshotTimestampUtc.ToString("u")</span>
            @if (_result.PriceSnapshot.IsStale)
            {
                <span class="badge badge-stale">stale</span>
            }
            @if (!string.IsNullOrWhiteSpace(_result.PriceSnapshot.ErrorMessage))
            {
                <div class="badge badge-unavailable">@_result.PriceSnapshot.ErrorMessage</div>
            }
        </p>
    </div>

    @if (_result.Plan is null)
    {
        <div class="card">
            <h3>Unable to plan</h3>
            <p>@_result.ErrorMessage</p>

            @if (_result.MissingItemIds.Count > 0)
            {
                <p>Missing prices for:</p>
                <ul>
                    @foreach (var itemId in _result.MissingItemIds)
                    {
                        <li>
                            @(_itemNames.GetValueOrDefault(itemId) ?? $"Item {itemId}")
                            <span class="badge">@itemId</span>
                        </li>
                    }
                </ul>
            }
        </div>
    }
    else
    {
        <div class="card">
            <h3>Steps</h3>
            @if (_result.Plan.SkillCreditApplied > 0)
            {
                <p>
                    Intermediate skill-ups applied: <span class="badge">@_result.Plan.SkillCreditApplied</span>
                    (expected: @_result.Plan.ExpectedSkillUpsFromIntermediates.ToString("0.##")).
                    These appear in the steps list as recipes marked <span class="badge">Intermediate</span>.
                </p>
            }
            <table>
                <thead>
                <tr>
                    <th>Skill</th>
                    <th>Recipe</th>
                    <th>Chance</th>
                    <th>Expected crafts</th>
                    <th>Expected cost</th>
                    <th>Materials</th>
                </tr>
                </thead>
                <tbody>
                @for (var i = 0; i < _result.Plan.Steps.Count; i++)
                {
                    var step = _result.Plan.Steps[i];
                    var breakdown = _result.Plan.StepBreakdowns.Count > i ? _result.Plan.StepBreakdowns[i] : null;
                    <tr>
                        <td>@step.SkillFrom - @step.SkillTo</td>
                        <td>
                            @step.RecipeName <span class="badge">@step.RecipeId</span>
                            @if (step.RecipeName.Contains("(Intermediate)", StringComparison.OrdinalIgnoreCase))
                            {
                                <span class="badge">Intermediate</span>
                            }
                            @if (step.LearnedByTrainer == false)
                            {
                                <span class="badge badge-stale">recipe not from trainer</span>
                            }
                        </td>
                        <td>@step.SkillUpChance</td>
                        <td>@step.ExpectedCrafts.ToString("0.##")</td>
                        <td>@step.ExpectedCost.ToGscString()</td>
                        <td>
                            @if (breakdown is null || (breakdown.Intermediates.Count == 0 && breakdown.Acquisitions.Count == 0))
                            {
                                <span class="badge">n/a</span>
                            }
                            else
                            {
                                <details>
                                    <summary>Show</summary>
                                    @if (breakdown.Intermediates.Count > 0)
                                    {
                                        <div style="margin-top:0.5rem">
                                            <div><strong>Intermediates</strong></div>
                                            <ul>
                                                @foreach (var line in breakdown.Intermediates)
                                                {
                                                    <li>
                                                        @(_itemNames.GetValueOrDefault(line.ItemId) ?? $"Item {line.ItemId}")
                                                        <span class="badge">@line.ItemId</span>
                                                        <span class="badge">@line.Kind</span>
                                                        need @line.RequiredQuantity.ToString("0.##")
                                                        @if (line.OwnedUsedQuantity > 0)
                                                        {
                                                            <span>(owned @line.OwnedUsedQuantity.ToString("0.##"))</span>
                                                        }
                                                        @if (line.ToProduceQuantity > 0)
                                                        {
                                                            <span>(make @line.ToProduceQuantity.ToString("0.##"))</span>
                                                        }
                                                    </li>
                                                }
                                            </ul>
                                        </div>
                                    }
                                    @if (breakdown.Acquisitions.Count > 0)
                                    {
                                        <div style="margin-top:0.5rem">
                                            <div><strong>Acquire</strong></div>
                                            <ul>
                                                @foreach (var line in breakdown.Acquisitions)
                                                {
                                                    <li>
                                                        @(_itemNames.GetValueOrDefault(line.ItemId) ?? $"Item {line.ItemId}")
                                                        <span class="badge">@line.ItemId</span>
                                                        <span class="badge">@(line.Source == AcquisitionSource.Vendor ? "vendor" : "AH")</span>
                                                        need @line.RequiredQuantity.ToString("0.##")
                                                        @if (line.OwnedUsedQuantity > 0)
                                                        {
                                                            <span>(owned @line.OwnedUsedQuantity.ToString("0.##"))</span>
                                                        }
                                                        @if (line.AcquireQuantity > 0)
                                                        {
                                                            <span>(get @line.AcquireQuantity.ToString("0.##"))</span>
                                                        }
                                                    </li>
                                                }
                                            </ul>
                                        </div>
                                    }
                                </details>
                            }
                        </td>
                    </tr>
                }
                </tbody>
            </table>
        </div>

        @if (_result.Plan.Intermediates.Count > 0)
        {
            <div class="card">
                <h3>Intermediates</h3>
                <table>
                    <thead>
                    <tr>
                        <th>Item</th>
                        <th>Quantity (expected)</th>
                        <th>Method</th>
                        <th>How</th>
                    </tr>
                    </thead>
                    <tbody>
                    @foreach (var line in _result.Plan.Intermediates)
                    {
                        <tr>
                            <td>
                                @(_itemNames.GetValueOrDefault(line.ItemId) ?? $"Item {line.ItemId}")
                                <span class="badge">@line.ItemId</span>
                            </td>
                            <td>@line.Quantity.ToString("0.##")</td>
                            <td>@line.Kind</td>
                            <td>@line.ProducerName</td>
                        </tr>
                    }
                    </tbody>
                </table>
            </div>
        }

        <div class="card">
            <h3>Shopping list</h3>
            <table>
                <thead>
                <tr>
                    <th>Item</th>
                    <th>Needed</th>
                    <th>Owned</th>
                    <th>Buy</th>
                    <th>Unit price</th>
                    <th>Line cost</th>
                </tr>
                </thead>
                <tbody>
                @foreach (var line in _shoppingRows)
                {
                    <tr>
                        <td>
                            @(_itemNames.GetValueOrDefault(line.ItemId) ?? $"Item {line.ItemId}")
                            <span class="badge">@line.ItemId</span>
                            @if (_vendorPricesCopper.ContainsKey(line.ItemId))
                            {
                                <span class="badge">vendor</span>
                            }
                          </td>
                          <td>@line.NeededQuantity.ToString("0.##")</td>
                          <td>@line.OwnedQuantity.ToString("0")</td>
                          <td>@line.BuyQuantity.ToString("0.##")</td>
                          <td>@line.UnitPrice.ToGscString()</td>
                          <td>@line.LineCost.ToGscString()</td>
                      </tr>
                  }
                </tbody>
            </table>

            <p>
                Total: <span class="badge">@_result.Plan.TotalCost.ToGscString()</span>
            </p>
        </div>
    }
}
@if (!string.IsNullOrWhiteSpace(_uiError))
{
    <div class="card">
        <h3>Error</h3>
        <pre style="white-space:pre-wrap">@_uiError</pre>
    </div>
}

@code {
    private IReadOnlyList<Profession> _professions = [];
    private int _professionId;
    private int _currentSkill = 1;
    private int _targetSkill = 300;
    private bool _useCraftIntermediates = false;
    private bool _useSmeltIntermediates = true;
    private bool _useOwnedMaterials = true;
    private bool _ready;
      private Dictionary<int, string> _itemNames = new();
      private Dictionary<int, long> _vendorPricesCopper = new();
      private Dictionary<int, long> _ownedByItemId = new();
      private IReadOnlyList<ShoppingRow> _shoppingRows = [];

    private PlanComputationResult? _result;
    private string? _uiError;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;

        await Selection.EnsureLoadedAsync();
        await PlannerPreferences.EnsureLoadedAsync();
        _professions = await RecipeRepository.GetProfessionsAsync(Selection.GameVersion, CancellationToken.None);

        var preferred = Selection.ProfessionId;
        _professionId = _professions.Any(p => p.ProfessionId == preferred)
            ? preferred
            : _professions.FirstOrDefault()?.ProfessionId ?? 0;

        _ready = _professionId != 0;
        StateHasChanged();
    }

    private async Task OnProfessionChanged()
    {
        Selection.ProfessionId = _professionId;
        await Selection.PersistAsync();
    }

    private async Task GenerateAsync()
    {
          _result = null;
          _uiError = null;
          _itemNames = new Dictionary<int, string>();
          _vendorPricesCopper = new Dictionary<int, long>();
          _ownedByItemId = new Dictionary<int, long>();
          _shoppingRows = [];

          try
          {
              IReadOnlyDictionary<int, long>? owned = null;
              if (_useOwnedMaterials)
              {
                  owned = await Owned.GetOwnedAsync(Selection.ToRealmKey().ToString(), "local");
              }

              _ownedByItemId = owned?.ToDictionary(kvp => kvp.Key, kvp => kvp.Value) ?? new Dictionary<int, long>();

            var request = new PlanRequest(
                RealmKey: Selection.ToRealmKey(),
                ProfessionId: _professionId,
                CurrentSkill: _currentSkill,
                TargetSkill: _targetSkill,
                PriceMode: PriceMode.Min,
                UseCraftIntermediates: _useCraftIntermediates,
                UseSmeltIntermediates: _useSmeltIntermediates,
                OwnedMaterials: owned,
                ExcludedRecipeIds: PlannerPreferences.GetExcludedRecipeIds(Selection.GameVersion, _professionId));

            _result = await Planner.BuildPlanAsync(request, CancellationToken.None);

            if (_result is null) return;

            var items = await ItemRepository.GetItemsAsync(Selection.GameVersion, CancellationToken.None);
            var vendor = await VendorPriceRepository.GetVendorPricesAsync(Selection.GameVersion, CancellationToken.None);
            _vendorPricesCopper = vendor.ToDictionary(kvp => kvp.Key, kvp => kvp.Value);

            var idsToName = new HashSet<int>(_result.MissingItemIds);
            if (_result.Plan is not null)
            {
                foreach (var id in _result.Plan.StepBreakdowns.SelectMany(x => x.Intermediates).Select(x => x.ItemId))
                {
                    idsToName.Add(id);
                }
                foreach (var id in _result.Plan.StepBreakdowns.SelectMany(x => x.Acquisitions).Select(x => x.ItemId))
                {
                    idsToName.Add(id);
                }

                foreach (var id in _result.Plan.ShoppingList.Select(s => s.ItemId))
                {
                    idsToName.Add(id);
                }

                foreach (var id in _result.Plan.Intermediates.Select(s => s.ItemId))
                {
                    idsToName.Add(id);
                }

                  foreach (var id in _result.Plan.OwnedMaterialsUsed.Select(s => s.ItemId))
                  {
                      idsToName.Add(id);
                  }

                  _shoppingRows = BuildShoppingRows(_result.Plan, _ownedByItemId);
              }

            foreach (var itemId in idsToName)
            {
                if (items.TryGetValue(itemId, out var name))
                {
                    _itemNames[itemId] = name;
                }
            }
        }
        catch (Exception ex)
        {
            _result = null;
            _uiError = ex.ToString();
        }
    }

      private sealed record ShoppingRow(
          int ItemId,
          decimal NeededQuantity,
          long OwnedQuantity,
          decimal BuyQuantity,
          Money UnitPrice,
          Money LineCost);

      private IReadOnlyList<ShoppingRow> BuildShoppingRows(PlanResult plan, IReadOnlyDictionary<int, long> ownedByItemId)
      {
          var ownedUsedByItemId = plan.OwnedMaterialsUsed
              .GroupBy(x => x.ItemId)
              .ToDictionary(g => g.Key, g => g.Sum(x => x.QuantityUsed));

        var buyByItemId = plan.ShoppingList.ToDictionary(x => x.ItemId, x => x);

        var allItemIds = new HashSet<int>(ownedUsedByItemId.Keys);
        foreach (var itemId in buyByItemId.Keys) allItemIds.Add(itemId);

          return allItemIds
              .OrderBy(x => x)
              .Select(itemId =>
              {
                  var ownedUsedQty = ownedUsedByItemId.GetValueOrDefault(itemId);
                  var ownedTotalQty = ownedByItemId.GetValueOrDefault(itemId);
                  var buyQty = buyByItemId.TryGetValue(itemId, out var buyLine) ? buyLine.Quantity : 0m;

                  var unit = buyByItemId.TryGetValue(itemId, out buyLine)
                      ? buyLine.UnitPrice
                      : GetUnitPrice(itemId);

                  var lineCost = unit * buyQty;
                  return new ShoppingRow(
                      ItemId: itemId,
                      NeededQuantity: ownedUsedQty + buyQty,
                      OwnedQuantity: ownedTotalQty,
                      BuyQuantity: buyQty,
                      UnitPrice: unit,
                      LineCost: lineCost);
              })
              .ToArray();
      }

    private Money GetUnitPrice(int itemId)
    {
        if (_vendorPricesCopper.TryGetValue(itemId, out var vendorCopper))
        {
            return new Money(vendorCopper);
        }

        if (_result?.PriceSnapshot.Prices.TryGetValue(itemId, out var summary) == true)
        {
            return new Money(summary.MinBuyoutCopper);
        }

        return Money.Zero;
    }
}
