name: Publish to CurseForge

on:
  workflow_dispatch:
    inputs:
      release_type:
        description: "releaseType: alpha | beta | release"
        required: true
        default: "beta"
      changelog:
        description: "Changelog (Markdown)"
        required: false
        default: ""
  push:
    branches:
      - "main"
    paths:
      - "FrugalForge/FrugalForge.toc"

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Read version from toc
        id: zip
        run: |
          set -e
          version=$(grep -E "^## Version:" FrugalForge/FrugalForge.toc | sed -E 's/^## Version: *//')
          if [ -z "$version" ]; then
            echo "No version found in FrugalForge.toc" >&2
            exit 1
          fi
          echo "version=$version" >> $GITHUB_OUTPUT

      - name: Build addon zip
        id: pack
        run: |
          set -e
          mkdir -p dist
          file="dist/FrugalForge-${VERSION}.zip"
          rm -f "$file"
          zip -r "$file" FrugalForge
          echo "file=$file" >> $GITHUB_OUTPUT
        env:
          VERSION: ${{ steps.zip.outputs.version }}

      - name: Commit zip to repo
        if: ${{ github.event_name == 'push' }}
        run: |
          set -e
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add dist/FrugalForge-*.zip
          if git diff --cached --quiet; then
            echo "No zip changes to commit."
            exit 0
          fi
          git commit -m "Add FrugalForge ${VERSION} zip"
          git push
        env:
          VERSION: ${{ steps.zip.outputs.version }}

      - name: Resolve CurseForge TBC version IDs
        id: cf_versions
        run: |
          set -e
          if [ -z "${CURSEFORGE_API_TOKEN}" ]; then
            echo "CURSEFORGE_API_TOKEN is not set" >&2
            exit 1
          fi
          versions=$(curl -sS -H "X-Api-Token: ${CURSEFORGE_API_TOKEN}" \
            "https://wow.curseforge.com/api/game/versions")
          tbc_type_id=$(echo "$versions" | jq -r '[.[] | select(.name|test("^2\\.5\\.")) | .gameVersionTypeID] | first')
          if [ -z "$tbc_type_id" ] || [ "$tbc_type_id" = "null" ]; then
            tbc_type_id=$(echo "$versions" | jq -r '.[] | select((.name|ascii_downcase) | test("burning crusade")) | .gameVersionTypeID' | head -n 1)
          fi
          if [ -z "$tbc_type_id" ] || [ "$tbc_type_id" = "null" ]; then
            echo "Failed to resolve TBC version type id" >&2
            echo "Sample versions:" >&2
            echo "$versions" | jq -r '.[] | "\(.gameVersionTypeID)\t\(.name)"' | head -n 30 >&2
            exit 1
          fi

          tbc_versions=$(echo "$versions" \
            | jq -r --argjson type "$tbc_type_id" '.[] | select(.gameVersionTypeID==$type) | .id' \
            | paste -sd "," -)
          if [ -z "$tbc_versions" ]; then
            echo "Failed to resolve TBC gameVersion IDs" >&2
            exit 1
          fi

          echo "tbc_type_id=$tbc_type_id" >> $GITHUB_OUTPUT
          echo "tbc_versions=$tbc_versions" >> $GITHUB_OUTPUT
        env:
          CURSEFORGE_API_TOKEN: ${{ secrets.CURSEFORGE_API_TOKEN }}

      - name: Build metadata
        id: meta
        run: |
          python - <<'PY'
          import json, os
          release_type = os.environ.get("RELEASE_TYPE", "beta")
          changelog = os.environ.get("CHANGELOG", "").strip()
          version = os.environ.get("VERSION", "")
          data = {
              "changelog": changelog if changelog else f"Release {version}",
              "changelogType": "markdown",
              "displayName": f"FrugalForge {version}",
              "releaseType": release_type,
          }
          game_version_type_id = os.environ.get("CURSEFORGE_GAME_VERSION_TYPE_ID")
          if game_version_type_id:
              try:
                  data["gameVersionTypeId"] = int(game_version_type_id)
              except ValueError:
                  pass
          game_versions_raw = os.environ.get("CURSEFORGE_GAME_VERSION_IDS") or ""
          if game_versions_raw:
              ids = []
              for part in game_versions_raw.split(","):
                  part = part.strip()
                  if not part:
                      continue
                  try:
                      ids.append(int(part))
                  except ValueError:
                      pass
              if ids:
                  data["gameVersions"] = ids
          with open("cf-metadata.json", "w", encoding="utf-8") as f:
              json.dump(data, f)
          print("metadata:", data)
          PY
        env:
          RELEASE_TYPE: ${{ github.event.inputs.release_type }}
          CHANGELOG: ${{ github.event.inputs.changelog }}
          VERSION: ${{ steps.zip.outputs.version }}
          CURSEFORGE_GAME_VERSION_TYPE_ID: ${{ steps.cf_versions.outputs.tbc_type_id }}
          CURSEFORGE_GAME_VERSION_IDS: ${{ steps.cf_versions.outputs.tbc_versions }}

      - name: Upload to CurseForge
        run: |
          resp=$(mktemp)
          status=$(curl -sS -o "$resp" -w "%{http_code}" \
            -X POST "https://wow.curseforge.com/api/projects/${CURSEFORGE_PROJECT_ID}/upload-file" \
            -H "X-Api-Token: ${CURSEFORGE_API_TOKEN}" \
            -F "metadata=@cf-metadata.json" \
            -F "file=@${ZIP_FILE}")
          echo "Upload status: $status"
          echo "Upload response:"
          cat "$resp"
          rm -f "$resp"
          if [ "$status" -lt 200 ] || [ "$status" -ge 300 ]; then
            exit 1
          fi
        env:
          CURSEFORGE_API_TOKEN: ${{ secrets.CURSEFORGE_API_TOKEN }}
          CURSEFORGE_PROJECT_ID: ${{ secrets.CURSEFORGE_PROJECT_ID }}
          ZIP_FILE: ${{ steps.pack.outputs.file }}
